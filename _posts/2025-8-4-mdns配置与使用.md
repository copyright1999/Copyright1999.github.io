---
layout:     post   				    
title:      mdns配置与使用			
subtitle:  
date:       2025-08-04				
author:     婷                               
header-img: img/159.png 	
catalog: true 						
tags:								

- 网络
- 组播
- mdns


---







## 简介

简单的介绍下`mdns`协议怎么配置跟使用



## 概念

- `MDNS`，也即是`Multicast DNS`，在小范围内本地网络中使用。与`DNS`相似的接口，数据包结构，操作语义的协议
- 优势：不需要有`DNS server`。`mDNS`利用局域网的`UDP`组播，让每台加入网络中的设备，向网络组播发布自己的主机名与IP地址
- 使用`UDP`连接，`5353`端口
- 组播地址：`224.0.0.251`，`fff02::fb`
- 只解析主机名带`.local`后缀的地址
- 可以在零配置网络中给自己分配域名，设备给自身选择一个域名后，然后通过发送记录类型为`any`的`mDNS`包来查询局域网内是否有同名，如果没有设备就会把这个名字作为自己的域名

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042227987.png)

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042227730.png)





## 配置

我们在树莓派上使用，目前有三种方案，`umdns`或者`avahi`或者`mdnsd`，我们选择`avahi`，需要打开的配置选项有

```Plain
BR2_PACKAGE_AVAHI=y
BR2_PACKAGE_AVAHI_DAEMON=y
BR2_PACKAGE_AVAHI_LIBDNSSD_COMPATIBILITY=y
BR2_PACKAGE_AVAHI_DEFAULT_SERVICES=y
BR2_PACKAGE_NSS_MDNS=y
```

配置好后更新`rootfs`，就可以`ps`看到`avahi-daemon: running [buildroot.local]`在运行了，这个时候我们分配给自己的域名就是`buildroot.local`

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042227968.png)



`PC`机来`ping`一下

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251270.png)

树莓派来`ping`我们的`PC`机，`PC`输入`hostname`获取我们的主机名

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251716.png)

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251885.png)

除了`avahi`，还有一个`nss_mdns`模块。主机上的`/etc/nssswitch.conf`文件，其中hosts一行，用来控制系统使用哪些服务来进行名称解析，以及顺序

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251811.png)

- `files`：优先查询`/etc/hosts`文件的数据
- `mdns6_minimal`：`ipv6`使用最小交互的`mdns`协议去查询域名
- `mdns4_minimal`：ipv4使用最小交互的`mdns`协议去查询域名
- `[NOTFOUND=return] `
- `dns`：从`DNS`服务器去查询域名，从`/etc/resolv.conf`获得`dns`服务器地址
- `mdns4`：`ipv4`使用完整的`mdns`协议去查询域名
- `mdns6`：`ipv6`使用完整的`mdns`协议去查询域名



## avahi命令相关用法

### 查找服务

列出所有本地注册的服务

```Plain
avahi-browse -a -r
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251875.png)



比如图中的`ssh`服务，那我们在同个局域网内就可以`ssh buildroot.local`

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042251943.png)

同理还有`http，ftp`等等



简洁一点的命令还有

```Plain
avahi-browse -a
avahi-browse -a -t
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252359.png)

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252799.png)





```Plain
avahi-browse -a -r -t
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252182.png)





### 修改局部域名

一般情况下，`xxx.local`中的`xxx`都是依据当前主机名字来的

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252123.png)

如果想要修改，有两种方式，一种是利用`avahi`的命令，比如设置主机`xxx`为`mdnstest`

```C
avahi-set-host-name mdnstest
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042253170.png)

另一种是修改`/etc/avahi/avahi-daemon.conf`文件，不过需要重启后才能生效

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252467.png)



### 查找域名对应的IP

```Plain
avahi-resolve -n DESKTOP-ED5M43N.local
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252140.png)

可以看到解析后并没有存到邻居表中，说明`avahi`是不会更新`IP`对应的`MAC`地址到邻居表中的。我个人理解是，这东西就类似于`DNS`服务那样，你收到服务器回给你的解析包，但是你能说这个解析的地址对应的`MAC`地址就是回复你的服务器的`MAC`地址吗，不能这样整吧。

但是只要`ping`了后就能会存到邻居表中，应该是`ping`的时候会走到`avahi`解析的地方

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042252853.png)



`strace`跟踪了一下`ping`的过程，可以看到最后走到`avahi`中去获取解析到的地址，然后再去通过`ipv6`的`RS`协议（类似于`ipv4`中的`ARP`协议）得到`DESKTOP-ED5M43N.local`的`MAC`地址，更新了邻居表

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042254705.png)

抓包看了下，大概就是这个意思

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042253286.png)



### 记录

在上一步修改局部域名后，`PC`进行`ping`树莓派的两个不同的局部域名，都能`ping`的通，我猜测是，一个是可以缓存，一个是只要是局域网内没同名的，这个条目依旧可以用。具体的原理倒是没时间去细究了

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042254902.png)





### 支持ipv6

尝试`ipv6`的时候，发现`ping -6`不通，但是能解析

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042254634.png)

前面知道`/etc/nsswitch.conf`文件跟`mdns`域名解析有关，查看该文件可以看到，并没有支持`ipv6`

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042254928.png)

直接修改文件，增加`ipv6`配置

```C
files mdns6_minimal mdns4_minimal [NOTFOUND=return] dns mdns4 mdns6
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255066.png)

好了，成功`ping`通了

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042254686.png)

正如前面配置中提到的，`/etc/nsswitch.conf`文件会决定解析的优先顺序，`mdns6_minimal`排在前面后，后续都是以`ipv6`优先解析





## 工作流程以及简单的报文解析 

`mdns`工作流程如下

- 查询阶段
  - 设备A需要解析`bbbb.local`的`IP`地址
  - 设备A向`mdns`组播地址`224.0.0.251`发送`DNS`查询请求
- 响应阶段
  - 局域网内加入了这个组播地址的设备接收到这个查询请求
  - 拥有`bbbb.local`域名的设备B会识别查询，并向设备A发送包含`bbbb.local`的主机名的IP地址的响应
- 缓存和重复查询
  - 设备A收到响应后，将该信息缓存，以便在短时间内再次查询时直接使用缓存数据，减少网络流量
  - 如果没有设备响应，设备A可以定期重发查询请求，直到获得相应

这里用`PC`来`ping`我们的树莓派进行抓包实验（如果是树莓派来`ping`我们的`PC`，可能会抓不到查询的包，貌似`PC`启动后就会一直往组播地址发自己的域名）

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255046.png)

抓包结果如下

- 包`382/383/384`：PC（`10.17.99.1 /fe80::4bd2:bf2:8235:e444`）先发起`ipv4`跟`ipv6`的`mdns`的问询
- 包`385/387/388`：树莓派（`10.17.99.133 /fe80::da3a:ddff:fe8c:a416`）响应了`PC`发出的请求

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255591.png)



## 参考链接

- [参考链接一](https://blog.csdn.net/easylife206/article/details/128795903)
- [参考链接二](https://energygreek.github.io/2021/03/10/setup-printer-use-avahi/)
- [参考链接三](https://www.haiyun.me/archives/1444.html)
- [参考链接四](https://blog.csdn.net/qq_27247815/article/details/140374077)
- [参考链接五](https://blog.csdn.net/zhu378287521/article/details/140667971)
- [mdns欺骗伪造](https://0xfay.github.io/posts/%E5%AF%B9mDNS%E7%9A%84%E4%B8%80%E4%BA%9B%E7%A0%94%E7%A9%B6)





## 问题

一开始碰到的是，`PC`能`ping`通树莓派，但是树莓派不行，排除了防火墙问题

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255123.png)

但是树莓派进行解析`PC`的域名是可以获取到`PC`的地址的

```Plain
avahi-resolve -n DESKTOP-ED5M43N.local
```

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255564.png)

后面排查发现，原来是`buildroot`配置的时候没有配置`BR2_PACKAGE_NSS_MDNS`，导致`/etc/nsswitch.conf`文件中内容不对，如下，只有`files dns`，少了其他

![img](https://raw.githubusercontent.com/copyright1999/image-typora-markdown/main/mdns/202508042255376.png)
